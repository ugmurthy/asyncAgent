openapi: 3.1.0
info:
  title: Async Agent API
  version: 0.2.0
  description: |
    RESTful API for managing autonomous agent goals, scheduled tasks, and run executions.
    Built with Fastify, uses SQLite for persistence, and supports multiple LLM providers.
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:3000/api/v1
    description: Development server
  - url: http://localhost:3000
    description: Health check endpoints

security:
  - bearerAuth: []
  - {}

tags:
  - name: health
    description: Health and readiness checks
  - name: goals
    description: Goal management operations
  - name: runs
    description: Run execution and monitoring
  - name: agents
    description: Agent management operations
  - name: tools
    description: Tool registry and definitions
  - name: dag
    description: DAG (Directed Acyclic Graph) creation and execution

paths:
  /health:
    get:
      tags:
        - health
      summary: Get health status
      description: Returns basic health status of the API
      operationId: getHealth
      security: []
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                timestamp: "2025-10-30T10:30:00.000Z"

  /health/ready:
    get:
      tags:
        - health
      summary: Get readiness status
      description: Returns detailed readiness status including LLM provider and scheduler info
      operationId: getHealthReady
      security: []
      responses:
        "200":
          description: API is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadinessResponse"
              example:
                status: ready
                provider: openai
                model: gpt-4o
                scheduler:
                  activeSchedules: 3
                timestamp: "2025-10-30T10:30:00.000Z"

  /api/v1/goals:
    get:
      tags:
        - goals
      summary: List all goals
      description: Retrieve all goals with optional status filtering
      operationId: listGoals
      parameters:
        - $ref: "#/components/parameters/GoalStatusQuery"
      responses:
        "200":
          description: List of goals
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GoalWithSchedules"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags:
        - goals
      summary: Create a new goal
      description: Create a new goal with optional schedule configuration
      operationId: createGoal
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateGoalRequest"
            examples:
              basic:
                summary: Basic goal
                value:
                  objective: Monitor GitHub repository for new issues and summarize them daily
                  params:
                    stepBudget: 20
              withSchedule:
                summary: Goal with schedule
                value:
                  objective: Daily market analysis
                  params:
                    stepBudget: 30
                    allowedTools:
                      - web_search
                      - web_scrape
                  schedule:
                    cronExpr: 0 9 * * *
                    timezone: UTC
      responses:
        "201":
          description: Goal created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Goal"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/goals/{id}:
    get:
      tags:
        - goals
      summary: Get goal by ID
      description: Retrieve a specific goal with its schedules
      operationId: getGoal
      parameters:
        - $ref: "#/components/parameters/GoalId"
      responses:
        "200":
          description: Goal details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoalWithSchedules"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    patch:
      tags:
        - goals
      summary: Update goal
      description: Update goal properties (objective, params, webhookUrl, status)
      operationId: updateGoal
      parameters:
        - $ref: "#/components/parameters/GoalId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateGoalRequest"
            example:
              objective: Updated objective text
              status: paused
      responses:
        "200":
          description: Goal updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Goal"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - goals
      summary: Delete goal
      description: Delete a goal and all its associated schedules and runs
      operationId: deleteGoal
      parameters:
        - $ref: "#/components/parameters/GoalId"
      responses:
        "204":
          description: Goal deleted successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/goals/{id}/run:
    post:
      tags:
        - goals
      summary: Trigger goal run
      description: Manually trigger a goal execution
      operationId: triggerGoalRun
      parameters:
        - $ref: "#/components/parameters/GoalId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
            example: {}
      responses:
        "200":
          description: Run triggered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TriggerRunResponse"
              example:
                runId: run_abc123
                message: Run triggered successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/goals/{id}/pause:
    post:
      tags:
        - goals
      summary: Pause goal
      description: Pause a goal and deactivate its schedules
      operationId: pauseGoal
      parameters:
        - $ref: "#/components/parameters/GoalId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
            example: {}
      responses:
        "200":
          description: Goal paused successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
              example:
                message: Goal paused successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/goals/{id}/resume:
    post:
      tags:
        - goals
      summary: Resume goal
      description: Resume a paused goal and reactivate its schedules
      operationId: resumeGoal
      parameters:
        - $ref: "#/components/parameters/GoalId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
            example: {}
      responses:
        "200":
          description: Goal resumed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
              example:
                message: Goal resumed successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/runs:
    get:
      tags:
        - runs
      summary: List all runs
      description: Retrieve all runs (limited to 50 most recent) with optional goalId and status filtering
      operationId: listRuns
      parameters:
        - name: goalId
          in: query
          required: false
          description: Filter runs by goal ID
          schema:
            type: string
            pattern: ^goal_[a-z0-9]+$
        - $ref: "#/components/parameters/RunStatusQuery"
      responses:
        "200":
          description: List of runs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/RunWithGoal"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/runs/{id}:
    get:
      tags:
        - runs
      summary: Get run by ID
      description: Retrieve a specific run with its associated goal
      operationId: getRun
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: Run details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunWithGoal"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - runs
      summary: Delete run
      description: Delete a specific run and all its steps
      operationId: deleteRun
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "204":
          description: Run deleted successfully
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/runs/{id}/steps:
    get:
      tags:
        - runs
      summary: Get run steps
      description: Retrieve all execution steps for a specific run
      operationId: getRunSteps
      parameters:
        - $ref: "#/components/parameters/RunId"
      responses:
        "200":
          description: List of steps
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Step"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/agents:
    get:
      tags:
        - agents
      summary: List all agents
      description: Retrieve all agents with optional filtering by name or active status
      operationId: listAgents
      parameters:
        - name: name
          in: query
          required: false
          description: Filter agents by name
          schema:
            type: string
        - name: active
          in: query
          required: false
          description: Filter agents by active status
          schema:
            type: string
            enum: ["true", "false"]
      responses:
        "200":
          description: List of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"
        "400":
          $ref: "#/components/responses/BadRequest"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags:
        - agents
      summary: Create a new agent
      description: Register a new agent version with name, version, and prompt template
      operationId: createAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateAgentRequest"
      responses:
        "201":
          description: Agent created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: Agent with this name and version already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/agents/{id}:
    get:
      tags:
        - agents
      summary: Get agent by ID
      description: Retrieve a specific agent by its ID
      operationId: getAgent
      parameters:
        - $ref: "#/components/parameters/AgentId"
      responses:
        "200":
          description: Agent details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    patch:
      tags:
        - agents
      summary: Update agent
      description: Update agent properties (name, version, promptTemplate, metadata)
      operationId: updateAgent
      parameters:
        - $ref: "#/components/parameters/AgentId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateAgentRequest"
            example:
              name: updated-agent
              version: v2.0
              promptTemplate: "New prompt template with {{objective}}"
      responses:
        "200":
          description: Agent updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Agent with this name and version already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: Agent with this name and version already exists
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - agents
      summary: Delete agent
      description: Delete an inactive agent (cannot delete active agents)
      operationId: deleteAgent
      parameters:
        - $ref: "#/components/parameters/AgentId"
      responses:
        "204":
          description: Agent deleted successfully
        "400":
          description: Cannot delete active agent
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: Cannot delete active agent. Activate another version first.
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/agents/{id}/activate:
    post:
      tags:
        - agents
      summary: Activate an agent
      description: Activate an agent and deactivate other versions with the same name
      operationId: activateAgent
      parameters:
        - $ref: "#/components/parameters/AgentId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              additionalProperties: false
            example: {}
      responses:
        "200":
          description: Agent activated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/agents/resolve/{name}:
    get:
      tags:
        - agents
      summary: Resolve active agent by name
      description: Get the currently active agent for a given name
      operationId: resolveAgent
      parameters:
        - name: name
          in: path
          required: true
          description: Agent name
          schema:
            type: string
      responses:
        "200":
          description: Active agent found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Agent"
        "404":
          description: No active agent found with this name
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/tools:
    get:
      tags:
        - tools
      summary: List all tools or get specific tool
      description: Retrieve all tool definitions or a specific tool by name
      operationId: listTools
      parameters:
        - name: name
          in: query
          required: false
          description: Filter tools by name (returns single tool if found)
          schema:
            type: string
      responses:
        "200":
          description: Tool definitions
          content:
            application/json:
              schema:
                oneOf:
                  - type: array
                    items:
                      $ref: "#/components/schemas/ToolDefinition"
                  - $ref: "#/components/schemas/ToolDefinition"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/create-dag:
    post:
      tags:
        - dag
      summary: Create a DAG from goal text
      description: Decompose a goal into a directed acyclic graph of sub-tasks
      operationId: createDAG
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDAGRequest"
      responses:
        "200":
          description: DAG created successfully or clarification required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateDAGResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/execute-dag:
    post:
      tags:
        - dag
      summary: Execute a DAG
      description: Start execution of a previously created DAG
      operationId: executeDAG
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dagId
              properties:
                dagId:
                  type: string
                  description: The DAG ID to execute
      responses:
        "202":
          description: DAG execution started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecuteDAGResponse"
        "200":
          description: Clarification required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClarificationResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/resume-dag/{executionId}:
    post:
      tags:
        - dag
      summary: Resume a suspended DAG execution
      description: Resume a suspended or failed DAG execution
      operationId: resumeDAG
      parameters:
        - name: executionId
          in: path
          required: true
          description: The execution ID to resume
          schema:
            type: string
            pattern: ^dag-exec_[a-z0-9]+$
      responses:
        "202":
          description: Execution resumed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResumeDAGResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/dag-executions:
    get:
      tags:
        - dag
      summary: List DAG executions
      description: Retrieve all DAG executions with optional filtering
      operationId: listDAGExecutions
      parameters:
        - name: limit
          in: query
          required: false
          description: Maximum number of results (default 50)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          required: false
          description: Number of results to skip (default 0)
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: status
          in: query
          required: false
          description: Filter by execution status
          schema:
            type: string
            enum: [pending, running, waiting, completed, failed, partial, suspended]
      responses:
        "200":
          description: List of DAG executions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DAGExecutionList"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/dag-executions/{id}:
    get:
      tags:
        - dag
      summary: Get DAG execution details
      description: Retrieve a specific DAG execution with its sub-steps
      operationId: getDAGExecution
      parameters:
        - name: id
          in: path
          required: true
          description: The execution ID
          schema:
            type: string
            pattern: ^dag-exec_[a-z0-9]+$
      responses:
        "200":
          description: DAG execution details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DAGExecutionWithSteps"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags:
        - dag
      summary: Delete DAG execution
      description: Delete a DAG execution and all its sub-steps
      operationId: deleteDAGExecution
      parameters:
        - name: id
          in: path
          required: true
          description: The execution ID
          schema:
            type: string
            pattern: ^dag-exec_[a-z0-9]+$
      responses:
        "200":
          description: Execution deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteDAGExecutionResponse"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/dag-executions/{id}/sub-steps:
    get:
      tags:
        - dag
      summary: Get DAG execution sub-steps
      description: Retrieve all sub-steps for a specific DAG execution
      operationId: getDAGExecutionSubSteps
      parameters:
        - name: id
          in: path
          required: true
          description: The execution ID
          schema:
            type: string
            pattern: ^dag-exec_[a-z0-9]+$
      responses:
        "200":
          description: List of sub-steps
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DAGSubStepsList"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /api/v1/dag-executions/{id}/events:
    get:
      tags:
        - dag
      summary: Stream DAG execution events
      description: Server-Sent Events stream for real-time DAG execution updates
      operationId: streamDAGExecutionEvents
      parameters:
        - name: id
          in: path
          required: true
          description: The execution ID
          schema:
            type: string
            pattern: ^dag-exec_[a-z0-9]+$
      responses:
        "200":
          description: SSE stream with execution events
          content:
            text/event-stream:
              schema:
                type: string
        "404":
          $ref: "#/components/responses/NotFound"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for API authentication

  parameters:
    GoalId:
      name: id
      in: path
      required: true
      description: Goal ID (format goal_xxxxx)
      schema:
        type: string
        pattern: ^goal_[a-z0-9]+$
      example: goal_abc123

    RunId:
      name: id
      in: path
      required: true
      description: Run ID (format run_xxxxx)
      schema:
        type: string
        pattern: ^run_[a-z0-9]+$
      example: run_xyz789

    AgentId:
      name: id
      in: path
      required: true
      description: Agent ID (format agent_xxxxx)
      schema:
        type: string
        pattern: ^agent_[a-z0-9]+$
      example: agent_abc123

    GoalStatusQuery:
      name: status
      in: query
      required: false
      description: Filter goals by status
      schema:
        $ref: "#/components/schemas/GoalStatus"

    RunStatusQuery:
      name: status
      in: query
      required: false
      description: Filter runs by status
      schema:
        $ref: "#/components/schemas/RunStatus"

  schemas:
    GoalStatus:
      type: string
      enum:
        - active
        - paused
        - archived
      description: Status of a goal

    RunStatus:
      type: string
      enum:
        - pending
        - running
        - completed
        - failed
      description: Status of a run execution

    OutputKind:
      type: string
      enum:
        - summary
        - file
        - webhook
        - email
      description: Type of output delivery

    MemoryType:
      type: string
      enum:
        - note
        - fact
        - artifact
      description: Type of memory entry

    GoalParams:
      type: object
      properties:
        stepBudget:
          type: integer
          minimum: 1
          description: Maximum number of steps allowed
          example: 20
        allowedTools:
          type: array
          items:
            type: string
          description: List of tools the agent can use
          example:
            - web_search
            - web_scrape
        constraints:
          type: object
          additionalProperties: true
          description: Additional constraints for the goal
          example:
            maxRetries: 3
      additionalProperties: false

    Goal:
      type: object
      required:
        - id
        - objective
        - params
        - status
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          pattern: ^goal_[a-z0-9]+$
          description: Unique goal identifier
          example: goal_abc123
        objective:
          type: string
          minLength: 10
          maxLength: 10000
          description: The goal objective description
          example: Monitor GitHub repository for new issues
        params:
          $ref: "#/components/schemas/GoalParams"
        webhookUrl:
          type: string
          format: uri
          nullable: true
          description: Optional webhook URL for notifications
          example: https://example.com/webhook
        agentId:
          type: string
          pattern: ^agent_[a-z0-9]+$
          nullable: true
          description: ID of the agent assigned to this goal
          example: agent_abc123
        status:
          $ref: "#/components/schemas/GoalStatus"
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"
        updatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"

    Schedule:
      type: object
      required:
        - id
        - goalId
        - cronExpr
        - timezone
        - active
        - createdAt
      properties:
        id:
          type: string
          pattern: ^sched_[a-z0-9]+$
          description: Unique schedule identifier
          example: sched_xyz789
        goalId:
          type: string
          pattern: ^goal_[a-z0-9]+$
          description: Associated goal ID
          example: goal_abc123
        cronExpr:
          type: string
          description: Cron expression for scheduling
          example: 0 9 * * *
        timezone:
          type: string
          description: Timezone for schedule
          default: UTC
          example: UTC
        active:
          type: boolean
          description: Whether schedule is active
          example: true
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"

    GoalWithSchedules:
      allOf:
        - $ref: "#/components/schemas/Goal"
        - type: object
          required:
            - schedules
          properties:
            schedules:
              type: array
              items:
                $ref: "#/components/schemas/Schedule"
              description: Associated schedules

    Run:
      type: object
      required:
        - id
        - goalId
        - status
        - workingMemory
        - stepBudget
        - stepsExecuted
        - createdAt
      properties:
        id:
          type: string
          pattern: ^run_[a-z0-9]+$
          description: Unique run identifier
          example: run_xyz789
        goalId:
          type: string
          pattern: ^goal_[a-z0-9]+$
          description: Associated goal ID
          example: goal_abc123
        status:
          $ref: "#/components/schemas/RunStatus"
        startedAt:
          type: string
          format: date-time
          nullable: true
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"
        endedAt:
          type: string
          format: date-time
          nullable: true
          description: ISO 8601 timestamp
          example: "2025-10-30T10:35:00.000Z"
        workingMemory:
          type: object
          additionalProperties: true
          description: Agent's working memory during execution
          example:
            lastChecked: "2025-10-30T10:30:00.000Z"
        stepBudget:
          type: integer
          minimum: 1
          description: Maximum steps allowed
          example: 20
        stepsExecuted:
          type: integer
          minimum: 0
          description: Number of steps executed
          example: 15
        error:
          type: string
          nullable: true
          description: Error message if run failed
          example: null
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"

    RunWithGoal:
      allOf:
        - $ref: "#/components/schemas/Run"
        - type: object
          required:
            - goal
          properties:
            goal:
              $ref: "#/components/schemas/Goal"

    Step:
      type: object
      required:
        - id
        - runId
        - stepNo
        - thought
        - durationMs
        - createdAt
      properties:
        id:
          type: string
          pattern: ^step_[a-z0-9]+$
          description: Unique step identifier
          example: step_abc123
        runId:
          type: string
          pattern: ^run_[a-z0-9]+$
          description: Associated run ID
          example: run_xyz789
        stepNo:
          type: integer
          minimum: 1
          description: Step sequence number
          example: 1
        thought:
          type: string
          description: Agent's reasoning for this step
          example: I need to search for recent GitHub issues
        toolName:
          type: string
          nullable: true
          description: Tool used in this step
          example: web_search
        toolInput:
          type: object
          nullable: true
          additionalProperties: true
          description: Input parameters for the tool
          example:
            query: github issues
        observation:
          type: string
          nullable: true
          description: Result of tool execution
          example: Found 5 new issues
        durationMs:
          type: integer
          minimum: 0
          description: Step execution time in milliseconds
          example: 1500
        error:
          type: string
          nullable: true
          description: Error message if step failed
          example: null
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"

    Agent:
      type: object
      required:
        - id
        - name
        - version
        - promptTemplate
        - active
        - metadata
        - createdAt
        - updatedAt
      properties:
        id:
          type: string
          pattern: ^agent_[a-z0-9]+$
          description: Unique agent identifier
          example: agent_abc123
        name:
          type: string
          description: Agent name
          example: defaultAgent
        version:
          type: string
          description: Agent version
          example: 1.0.0
        promptTemplate:
          type: string
          description: Agent prompt template
          example: You are a helpful assistant that...
        provider:
          type: string
          description: LLM provider for this agent
          example: openai
        model:
          type: string
          description: LLM model for this agent
          example: gpt-4o
        active:
          type: boolean
          description: Whether this agent version is active
          example: true
        metadata:
          type: object
          additionalProperties: true
          description: Additional agent metadata
          example: {}
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"
        updatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-10-30T10:30:00.000Z"

    CreateAgentRequest:
      type: object
      required:
        - name
        - version
        - promptTemplate
      properties:
        name:
          type: string
          minLength: 1
          description: Agent name
          example: defaultAgent
        version:
          type: string
          minLength: 1
          description: Agent version
          example: 1.0.0
        promptTemplate:
          type: string
          minLength: 1
          description: Agent prompt template
          example: You are a helpful assistant that...
        provider:
          type: string
          description: LLM provider for this agent
          example: openai
        model:
          type: string
          description: LLM model for this agent
          example: gpt-4o
        metadata:
          type: object
          additionalProperties: true
          description: Additional agent metadata
          example: {}
      additionalProperties: false

    UpdateAgentRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          description: Agent name
          example: defaultAgent
        version:
          type: string
          minLength: 1
          description: Agent version
          example: 1.0.0
        promptTemplate:
          type: string
          minLength: 1
          description: Agent prompt template
          example: You are a helpful assistant that...
        provider:
          type: string
          description: LLM provider for this agent
          example: openai
        model:
          type: string
          description: LLM model for this agent
          example: gpt-4o
        metadata:
          type: object
          additionalProperties: true
          description: Additional agent metadata
          example: {}
      additionalProperties: false

    ToolDefinition:
      type: object
      required:
        - type
        - function
      properties:
        type:
          type: string
          enum: [function]
          description: Tool type
        function:
          type: object
          required:
            - name
            - description
          properties:
            name:
              type: string
              description: Tool function name
            description:
              type: string
              description: Tool description
            parameters:
              type: object
              description: JSON Schema for tool parameters
              additionalProperties: true

    CreateDAGRequest:
      type: object
      required:
        - goal-text
        - agentName
      properties:
        goal-text:
          type: string
          minLength: 1
          description: The goal description to decompose
        agentName:
          type: string
          minLength: 1
          description: Name of the agent to use
        provider:
          type: string
          description: Optional LLM provider override
        model:
          type: string
          description: Optional LLM model override
        max_tokens:
          type: integer
          description: Maximum tokens for LLM response
        temperature:
          type: number
          description: LLM temperature (0-2)
        seed:
          type: integer
          description: Random seed for reproducibility

    CreateDAGResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [success, clarification_required]
        result:
          $ref: "#/components/schemas/DecomposerJob"
        clarification_query:
          type: string
          nullable: true
        usage:
          type: object
          nullable: true
          additionalProperties: true
        generation_stats:
          type: object
          nullable: true
          additionalProperties: true
        attempts:
          type: integer

    DecomposerJob:
      type: object
      required:
        - original_request
        - intent
        - entities
        - sub_tasks
        - synthesis_plan
        - validation
        - clarification_needed
      properties:
        original_request:
          type: string
        intent:
          type: object
          required:
            - primary
            - sub_intents
          properties:
            primary:
              type: string
            sub_intents:
              type: array
              items:
                type: string
        entities:
          type: array
          items:
            type: object
            required:
              - entity
              - type
              - grounded_value
            properties:
              entity:
                type: string
              type:
                type: string
              grounded_value:
                type: string
        sub_tasks:
          type: array
          items:
            $ref: "#/components/schemas/SubTask"
        synthesis_plan:
          type: string
        validation:
          type: object
          required:
            - coverage
            - gaps
            - iteration_triggers
          properties:
            coverage:
              type: string
            gaps:
              type: array
              items:
                type: string
            iteration_triggers:
              type: array
              items:
                type: string
        clarification_needed:
          type: boolean
        clarification_query:
          type: string
          nullable: true

    SubTask:
      type: object
      required:
        - id
        - description
        - thought
        - action_type
        - tool_or_prompt
        - expected_output
        - dependencies
      properties:
        id:
          type: string
        description:
          type: string
        thought:
          type: string
        action_type:
          type: string
          enum: [tool, inference]
        tool_or_prompt:
          type: object
          required:
            - name
          properties:
            name:
              type: string
            params:
              type: object
              additionalProperties: true
        expected_output:
          type: string
        dependencies:
          type: array
          items:
            type: string

    ExecuteDAGResponse:
      type: object
      required:
        - status
        - executionId
        - dagId
        - originalRequest
        - totalTasks
        - message
      properties:
        status:
          type: string
          enum: [started]
        executionId:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        dagId:
          type: string
        originalRequest:
          type: string
        totalTasks:
          type: integer
        message:
          type: string

    ClarificationResponse:
      type: object
      required:
        - status
        - clarification_query
      properties:
        status:
          type: string
          enum: [clarification_required]
        clarification_query:
          type: string
        validation:
          type: object
          additionalProperties: true

    ResumeDAGResponse:
      type: object
      required:
        - status
        - executionId
        - dagId
        - retryCount
        - message
      properties:
        status:
          type: string
          enum: [resumed]
        executionId:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        dagId:
          type: string
        retryCount:
          type: integer
        message:
          type: string

    DAGExecution:
      type: object
      required:
        - id
        - dagId
        - status
        - completedTasks
        - failedTasks
        - waitingTasks
        - retryCount
        - createdAt
      properties:
        id:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        dagId:
          type: string
          nullable: true
        status:
          type: string
          enum: [pending, running, waiting, completed, failed, partial, suspended]
        completedTasks:
          type: integer
        failedTasks:
          type: integer
        waitingTasks:
          type: integer
        startedAt:
          type: string
          format: date-time
          nullable: true
        endedAt:
          type: string
          format: date-time
          nullable: true
        lastRetryAt:
          type: string
          format: date-time
          nullable: true
        retryCount:
          type: integer
        error:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    DAGExecutionWithSteps:
      allOf:
        - $ref: "#/components/schemas/DAGExecution"
        - type: object
          required:
            - subSteps
          properties:
            subSteps:
              type: array
              items:
                $ref: "#/components/schemas/SubStepRecord"

    SubStepRecord:
      type: object
      required:
        - id
        - executionId
        - taskId
        - status
        - createdAt
      properties:
        id:
          type: string
          pattern: ^substep_[a-z0-9]+$
        executionId:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        taskId:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed, blocked, waiting]
        result:
          type: object
          nullable: true
          additionalProperties: true
        error:
          type: string
          nullable: true
        durationMs:
          type: integer
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true

    DAGExecutionList:
      type: object
      required:
        - executions
        - pagination
      properties:
        executions:
          type: array
          items:
            $ref: "#/components/schemas/DAGExecution"
        pagination:
          type: object
          required:
            - limit
            - offset
            - count
          properties:
            limit:
              type: integer
            offset:
              type: integer
            count:
              type: integer

    DAGSubStepsList:
      type: object
      required:
        - executionId
        - subSteps
      properties:
        executionId:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        subSteps:
          type: array
          items:
            $ref: "#/components/schemas/SubStepRecord"

    DeleteDAGExecutionResponse:
      type: object
      required:
        - message
        - executionId
        - cascadeInfo
      properties:
        message:
          type: string
        executionId:
          type: string
          pattern: ^dag-exec_[a-z0-9]+$
        cascadeInfo:
          type: object
          required:
            - relatedSubStepsDeleted
          properties:
            relatedSubStepsDeleted:
              type: integer

    CreateGoalRequest:
      type: object
      required:
        - objective
      properties:
        objective:
          type: string
          minLength: 10
          maxLength: 10000
          description: The goal objective description
          example: Monitor GitHub repository for new issues
        params:
          $ref: "#/components/schemas/GoalParams"
        webhookUrl:
          type: string
          format: uri
          description: Optional webhook URL for notifications
          example: https://example.com/webhook
        agentName:
          type: string
          description: Optional agent name to use for this goal (uses active version)
          example: defaultAgent
        agentId:
          type: string
          pattern: ^agent_[a-z0-9]+$
          description: Optional specific agent ID to use for this goal
          example: agent_abc123
        schedule:
          type: object
          required:
            - cronExpr
          properties:
            cronExpr:
              type: string
              description: Cron expression
              example: 0 9 * * *
            timezone:
              type: string
              description: Timezone for schedule
              default: UTC
              example: UTC
          additionalProperties: false
      additionalProperties: false

    UpdateGoalRequest:
      type: object
      properties:
        objective:
          type: string
          minLength: 10
          maxLength: 10000
          description: Updated goal objective
          example: Updated objective text
        params:
          $ref: "#/components/schemas/GoalParams"
        webhookUrl:
          type: string
          format: uri
          nullable: true
          description: Updated webhook URL
          example: https://example.com/webhook
        status:
          $ref: "#/components/schemas/GoalStatus"
      additionalProperties: false

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum:
            - ok
          example: ok
        timestamp:
          type: string
          format: date-time
          example: "2025-10-30T10:30:00.000Z"

    ReadinessResponse:
      type: object
      required:
        - status
        - provider
        - model
        - scheduler
        - timestamp
      properties:
        status:
          type: string
          enum:
            - ready
          example: ready
        provider:
          type: string
          description: LLM provider name
          example: openai
        model:
          type: string
          description: LLM model name
          example: gpt-4o
        scheduler:
          type: object
          required:
            - activeSchedules
          properties:
            activeSchedules:
              type: integer
              minimum: 0
              description: Number of active schedules
              example: 3
        timestamp:
          type: string
          format: date-time
          example: "2025-10-30T10:30:00.000Z"

    TriggerRunResponse:
      type: object
      required:
        - runId
        - message
      properties:
        runId:
          type: string
          pattern: ^run_[a-z0-9]+$
          description: ID of the triggered run
          example: run_abc123
        message:
          type: string
          example: Run triggered successfully

    MessageResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: Operation completed successfully

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Resource not found

  responses:
    BadRequest:
      description: Bad Request - validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Invalid request parameters

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Resource not found

    TooManyRequests:
      description: Too many requests - rate limit exceeded
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Rate limit exceeded. Maximum 100 requests per minute.

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error: Internal server error
